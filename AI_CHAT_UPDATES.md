# Обновления диалогового окна чата с AI-ассистентом

## Выполненные улучшения

### 1. Расширение окна чата
- **Изменение**: Ширина диалогового окна увеличена с `max-w-4xl` до `max-w-6xl`
- **Файл**: `/src/components/ai-assistant/ai-chat-dialog.tsx`
- **Результат**: Более просторный интерфейс для работы с чатом

### 2. Перенос кнопки вызова чата
- **Изменение**: Кнопка "AI-ассистент" перенесена из плавающей кнопки в левое боковое меню
- **Файлы**: 
  - `/src/components/layout/sidebar-nav.tsx` - добавлена кнопка в нижней части меню
  - `/src/components/layout/main-layout.tsx` - добавлена обработка клика и управление состоянием
  - `/src/app/page.tsx` - удалена плавающая кнопка
- **Результат**: Удобный доступ к AI-ассистенту из любого раздела приложения

### 3. Исправление сохранения выбранной модели
- **Проблема**: Модель не сохранялась при выборе в интерфейсе
- **Решение**: Добавлено автоматическое сохранение модели при выборе
- **Файл**: `/src/app/admin/ai-settings/page.tsx`
- **Изменения**: 
  - Функция `handleInputChange` теперь асинхронная
  - При изменении модели отправляется PUT-запрос на сохранение
  - Обработка ошибок при сохранении
- **Результат**: Выбранная модель немедленно сохраняется и становится активной

### 4. Добавление поддержки других провайдеров
- **Новые провайдеры**: LM Studio, Z.AI, OpenAI, Anthropic
- **Файлы**:
  - `/src/app/api/ai-settings/route.ts` - обновлен интерфейс настроек
  - `/src/app/api/ai-assistant/route.ts` - добавлена поддержка разных провайдеров
  - `/src/components/ai-assistant/ai-chat-dialog.tsx` - обновлен интерфейс чата
  - `/src/app/admin/ai-settings/page.tsx` - добавлен выбор провайдера
- **Функциональность**:
  - Выбор провайдера в настройках
  - Автоматическая настройка URL и заголовков для каждого провайдера
  - Отображение имени провайдера в статусе подключения
  - Поддержка специфичных параметров для каждого провайдера

### 5. Улучшение системы подключения
- **Проблема**: Ошибка "Ошибка подключения к LM Studio" даже при успешном тестировании
- **Решение**: 
  - Улучшена обработка ошибок подключения
  - Добавлена поддержка разных провайдеров в GET-запросе
  - Исправлена логика проверки статуса подключения
- **Файлы**: 
  - `/src/app/api/ai-assistant/route.ts` - улучшен GET endpoint
  - `/src/app/api/ai-settings/route.ts` - улучшена функция testConnection
- **Результат**: Корректное отображение статуса подключения для любого провайдера

## Технические детали

### Изменения в API

#### Настройки AI (`/api/ai-settings`)
```typescript
interface AISettings {
  id: string
  provider: 'lm-studio' | 'z-ai' | 'openai' | 'anthropic'  // Новое поле
  lmStudioUrl: string
  apiKey: string
  defaultModel: string
  temperature: number
  maxTokens: number
  topP: number
  isActive: boolean
  updatedAt: string
}
```

#### AI Assistant (`/api/ai-assistant`)
```typescript
// Новый параметр в запросе
{
  messages,
  model,
  temperature,
  max_tokens,
  top_p,
  context,
  provider: 'lm-studio' | 'z-ai' | 'openai' | 'anthropic'  // Новый параметр
}
```

### Конфигурация провайдеров
```typescript
const AI_PROVIDERS = {
  'lm-studio': {
    baseUrl: process.env.LM_STUDIO_BASE_URL || 'http://localhost:1234',
    apiKey: process.env.LM_STUDIO_API_KEY || 'your-api-key',
    defaultModel: process.env.LM_STUDIO_DEFAULT_MODEL || 'TheBloke/Mistral-7B-Instruct-v0.2-GGUF',
    // ...
  },
  'z-ai': {
    baseUrl: process.env.Z_AI_BASE_URL || 'http://localhost:1234',
    apiKey: process.env.Z_AI_API_KEY || 'your-api-key',
    defaultModel: process.env.Z_AI_DEFAULT_MODEL || 'gpt-3.5-turbo',
    // ...
  },
  'openai': {
    baseUrl: 'https://api.openai.com/v1',
    apiKey: process.env.OPENAI_API_KEY || 'your-openai-key',
    defaultModel: process.env.OPENAI_DEFAULT_MODEL || 'gpt-3.5-turbo',
    // ...
  },
  'anthropic': {
    baseUrl: 'https://api.anthropic.com/v1',
    apiKey: process.env.ANTHROPIC_API_KEY || 'your-anthropic-key',
    defaultModel: process.env.ANTHROPIC_DEFAULT_MODEL || 'claude-3-sonnet-20240229',
    // ...
  }
}
```

### Изменения в интерфейсе

#### Боковое меню
- Добавлена кнопка "AI-ассистент" в нижней части левого бокового меню
- Кнопка доступна на всех страницах приложения
- Стилизована в соответствии с общим дизайном меню

#### Настройки провайдера
- Добавлен выпадающий список выбора провайдера
- Динамическое обновление подсказок в зависимости от выбранного провайдера
- Автоматическая настройка параметров подключения

#### Статус подключения
- Отображение имени текущего провайдера в статусе
- Улучшенные сообщения об ошибках с указанием провайдера
- Корректная работа с разными URL и API ключами

## Результаты

### Пользовательские улучшения
1. **Более удобный доступ** - AI-ассистент доступен из бокового меню на любой странице
2. **Просторный интерфейс** - Увеличенное окно чата обеспечивает комфортную работу
3. **Надежное сохранение** - Выбранная модель немедленно сохраняется и активируется
4. **Гибкость выбора** - Возможность использовать различные AI-провайдеры
5. **Стабильная работа** - Исправлены ошибки подключения и статуса

### Технические улучшения
1. **Модульная архитектура** - Поддержка разных провайдеров через единую систему конфигурации
2. **Обработка ошибок** - Улучшенная логика обработки ошибок сети и API
3. **Типизация** - Строгая типизация для всех новых параметров
4. **Совместимость** - Сохранена обратная совместимость с существующим функционалом

## Инструкции по использованию

### Для пользователя
1. **Доступ к AI-ассистенту**: Нажмите кнопку "AI-ассистент" в левом боковом меню
2. **Выбор провайдера**: Перейдите в "Администрирование" → "Настройки AI" → выберите провайдера
3. **Настройка подключения**: Введите URL и API ключ для выбранного провайдера
4. **Выбор модели**: После успешного подключения выберите модель из списка
5. **Использование чата**: Модель автоматически сохраняется и готова к использованию

### Для администратора
1. **Настройка провайдеров**: Выберите подходящий провайдер в настройках
2. **Мониторинг статуса**: Проверяйте статус подключения в интерфейсе настроек
3. **Управление моделями**: Тестируйте и выбирайте оптимальные модели для задач
4. **Обработка ошибок**: Используйте улучшенные сообщения об ошибках для диагностики

## Совместимость
- Все изменения обратно совместимы с существующим функционалом
- Сохранены все предыдущие настройки и конфигурации
- Поддерживается работа с LM Studio как основным провайдером по умолчанию